name: Benchmark
on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch:
jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            compiler: clang
            cc: clang
            cxx: clang++
            name: "Ubuntu Clang"
            cmake_cxx: /usr/bin/clang++-20
          - os: ubuntu-latest
            compiler: gcc
            cc: gcc
            cxx: g++
            name: "Ubuntu GCC"
            cmake_cxx: /usr/bin/g++-14
          - os: macos-latest
            compiler: clang
            cc: clang
            cxx: clang++
            name: "macOS Clang"
            cmake_cxx: ""
          - os: macos-latest
            compiler: gcc
            cc: gcc
            cxx: g++
            name: "macOS GCC"
            cmake_cxx: ""
          - os: windows-latest
            compiler: msvc
            name: "Windows MSVC"
            cmake_cxx: ""
    runs-on: ${{ matrix.os }}
    name: Build on ${{ matrix.name }}
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Setup Clang (Ubuntu)
      if: matrix.os == 'ubuntu-latest' && matrix.compiler == 'clang'
      run: |
        sudo apt-get update
        sudo apt update
        wget https://apt.llvm.org/llvm.sh
        chmod u+x llvm.sh
        sudo ./llvm.sh 20
    
    - name: Setup GCC (Ubuntu)
      if: matrix.os == 'ubuntu-latest' && matrix.compiler == 'gcc'
      run: |
        sudo apt-get install build-essential
        sudo apt-get install g++-14
    
    - name: Setup Clang (macOS)
      if: matrix.os == 'macos-latest' && matrix.compiler == 'clang'
      run: |
        brew install llvm
    
    - name: Setup GCC (macOS)
      if: matrix.os == 'macos-latest' && matrix.compiler == 'gcc'
      run: |
        brew install gcc
        GCC_PATH=$(brew --prefix gcc)
        GCC_VER=$(ls ${GCC_PATH}/bin/gcc-* 2>/dev/null | grep -oE '[0-9]+$' | sort -rn | head -1)
        echo "CC=${GCC_PATH}/bin/gcc-${GCC_VER}" >> $GITHUB_ENV
        echo "CXX=${GCC_PATH}/bin/g++-${GCC_VER}" >> $GITHUB_ENV
        ${GCC_PATH}/bin/gcc-${GCC_VER} --version
        ${GCC_PATH}/bin/g++-${GCC_VER} --version
    
    - name: Setup MSVC (Windows)
      if: matrix.os == 'windows-latest'
      uses: ilammy/msvc-dev-cmd@v1
    
    - name: Create Build Directory
      run: mkdir -p Build
    
    - name: Configure CMake (Ubuntu-GCC)
      if: matrix.os == 'ubuntu-latest' && matrix.compiler == 'gcc'
      run: |
        cmake -S . -B ./Build -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER=${{ matrix.cmake_cxx }} -DBENCHMARKS=TRUE -DPRINT_ASSEMBLY=TRUE
    
    - name: Configure CMake (Ubuntu-Clang)
      if: matrix.os == 'ubuntu-latest' && matrix.compiler == 'clang'
      run: |
        cmake -S . -B ./Build -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER=${{ matrix.cmake_cxx }} -DBENCHMARKS=TRUE -DPRINT_ASSEMBLY=TRUE
    
    - name: Configure CMake (macOS-Clang)
      if: matrix.os == 'macos-latest' && matrix.compiler == 'clang'
      run: |
        cmake -S . -B ./Build -DCMAKE_BUILD_TYPE=Release -DBENCHMARKS=TRUE -DPRINT_ASSEMBLY=TRUE
    
    - name: Configure CMake (macOS-GCC)
      if: matrix.os == 'macos-latest' && matrix.compiler == 'gcc'
      run: |
        cmake -S . -B ./Build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=${{ env.CC }} -DCMAKE_CXX_COMPILER=${{ env.CXX }} -DBENCHMARKS=TRUE -DPRINT_ASSEMBLY=TRUE
    
    - name: Configure CMake (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        cmake -S . -B ./Build -DCMAKE_BUILD_TYPE=Release -DBENCHMARKS=TRUE -DPRINT_ASSEMBLY=TRUE
    
    - name: Build the Test
      run: |
            cmake --build ./Build --config=Release
    
    - name: Find and Print Assembly Files (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        echo "=== Searching for assembly files ==="
        find ./Build -name "*.asm" -type f
        echo ""
        echo "=== Assembly file details ==="
        find ./Build -name "*.asm" -type f -exec sh -c 'echo "File: {}"; ls -lh "{}"; echo "Lines: $(wc -l < "{}")"; echo ""' \;
        echo ""
        echo "=== Printing COMPLETE assembly files ==="
        find ./Build -name "*.asm" -type f -exec sh -c 'echo "========== {} =========="; cat "{}"; echo ""; echo "========== END OF {} =========="; echo ""' \;
    
    - name: Find and Print Assembly Files (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        echo "=== Searching for assembly files ==="
        echo "Current directory:"
        Get-Location
        echo ""
        echo "Build directory contents:"
        Get-ChildItem -Path ./Build -Recurse | Select-Object FullName
        echo ""
        echo "Specifically checking ./Build/src/:"
        if (Test-Path ./Build/src) {
          Get-ChildItem -Path ./Build/src -File | Select-Object Name, Length
        } else {
          echo "./Build/src does not exist!"
        }
        echo ""
        echo "Searching for .cod files recursively:"
        $asmFiles = Get-ChildItem -Path ./Build -Recurse -Filter "*.cod" -File -ErrorAction SilentlyContinue
    
        if ($null -eq $asmFiles -or $asmFiles.Count -eq 0) {
          echo "NO .ASM FILES FOUND!"
          echo ""
          echo "Checking if /Fa flag was applied - looking for compilation output:"
          Get-ChildItem -Path ./Build/src -Recurse -File | Where-Object { $_.Extension -match '\.(obj|cod|cod)' } | Select-Object FullName
        } else {
          echo "Found $($asmFiles.Count) assembly file(s):"
          $asmFiles | ForEach-Object { echo $_.FullName }
      
          echo ""
          echo "=== Assembly file details ==="
          $asmFiles | ForEach-Object {
            echo "File: $($_.FullName)"
            echo "Size: $($_.Length) bytes"
            echo "Lines: $((Get-Content $_.FullName).Count)"
            echo ""
          }
      
          echo ""
          echo "=== Printing COMPLETE assembly files ==="
          $asmFiles | ForEach-Object {
            echo "========== $($_.FullName) =========="
            Get-Content $_.FullName
            echo ""
            echo "========== END OF $($_.FullName) =========="
            echo ""
          }
        }
        
    - name: Install the Test (Unix)
      if: matrix.os != 'windows-latest'
      run: |
            sudo cmake --install ./Build --config=Release
    
    - name: Install the Test (Windows)
      if: matrix.os == 'windows-latest'
      run: |
            cmake --install ./Build --config=Release
    
    - name: Run the Test (Unix)
      if: matrix.os != 'windows-latest'
      run: |
            sudo chmod +x /usr/local/bin/benchmarksuite-main    
            sudo /usr/local/bin/benchmarksuite-main
    
    - name: Run the Test (Windows)
      if: matrix.os == 'windows-latest'
      run: |
            & "C:/Program Files (x86)/benchmarksuite/bin/benchmarksuite-main.exe"